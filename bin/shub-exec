#!/usr/bin/env python2
# -*- coding: utf-8 -*-
import os
import json
from argparse import ArgumentParser


def _jobdata():
    return json.loads(os.environ.get('SHUB_JOB_DATA', '{}'))


def _exec_args(jobdata):
    if not jobdata:
        return []
    if 'job_cmd' in jobdata:
        args = jobdata.get('job_cmd', [])
    else:
        spider_args = jobdata.get('spider_args', {})
        args = [jobdata['spider']]
        for key, value in spider_args.items():
            args.append(u'--{}={}'.format(key, value))
    return [x.encode('utf-8') for x in args]


def _settings():
    settings = json.loads(os.environ.get('SHUB_SETTINGS', '{}'))
    merged = {}
    for key in ['organization_settings', 'project_settings',
                'spider_settings', 'job_settings']:
        merged.update(settings.get(key) or {})
    return merged


def _exec_env(settings):
    env = dict(os.environ)
    env.update({
        k.encode('utf-8'): unicode(v).encode('utf-8') for k, v in settings.items()
    })
    return env


def main():
    ap = ArgumentParser()
    ap.add_argument('--ignore-path', action='store_true',
                    help="Do not use PATH environment variable to locate "
                         "program file")
    ap.add_argument('cmd', nargs='*')
    args = ap.parse_args()

    jobdata = _jobdata()
    settings = _settings()
    exec_args = args.cmd + _exec_args(jobdata)
    exec_env = _exec_env(settings)

    exec_syscall = os.execve if args.ignore_path else os.execvpe
    exec_syscall(exec_args[0], exec_args, exec_env)


if __name__ == '__main__':
    main()
